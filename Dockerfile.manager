# Dockerfile optimizado para Render (sin Docker-in-Docker)
FROM ubuntu:22.04

# Variables de entorno
ENV DEBIAN_FRONTEND=noninteractive
ENV NODE_VERSION=18

# Actualizar sistema e instalar dependencias básicas
RUN apt-get update && apt-get upgrade -y

# Instalar dependencias del sistema en capas para mejor caching
RUN apt-get install -y \
    curl \
    wget \
    ca-certificates \
    gnupg \
    lsb-release \
    software-properties-common

# Instalar Node.js 18 desde el repositorio oficial de Ubuntu
RUN curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg && \
    echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_18.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list && \
    apt-get update && \
    apt-get install -y nodejs

# Instalar otras herramientas necesarias
RUN apt-get install -y \
    nginx \
    supervisor \
    python3 \
    python3-pip \
    postgresql-client \
    redis-tools \
    build-essential

# Verificar instalación de Node.js
RUN node --version && npm --version

# Instalar Ollama
RUN curl -fsSL https://ollama.com/install.sh | sh

# Crear usuario para n8n explícitamente
RUN useradd -m -s /bin/bash n8n

# Instalar n8n globalmente
RUN npm install -g n8n@latest

# Crear directorios de trabajo
RUN mkdir -p /app /var/log/supervisor /etc/supervisor/conf.d /var/log/nginx

# Copiar archivos de configuración
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf
COPY nginx.conf /etc/nginx/sites-available/default
COPY start.sh /app/start.sh
COPY evolution-api.js /app/evolution-api.js
COPY package.json /app/package.json

# Configurar permisos
RUN chmod +x /app/start.sh
RUN mkdir -p /home/n8n/.n8n && chown -R n8n:n8n /home/n8n

# Instalar dependencias de Node.js para Evolution API
WORKDIR /app
RUN npm install --production

# Limpiar cache de apt
RUN apt-get clean && rm -rf /var/lib/apt/lists/*

# Exponer puerto
EXPOSE 10000

# Usar supervisor para manejar múltiples procesos
CMD ["/app/start.sh"]
