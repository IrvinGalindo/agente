FROM node:18-alpine

# Instalar dependencias del sistema
RUN apk add --no-cache curl bash

# Crear directorio de la aplicación
WORKDIR /app

# Copiar archivos de configuración
COPY package.json ./

# Limpiar cache de npm e instalar dependencias
RUN npm cache clean --force
RUN npm install --only=production --verbose

# Copiar código fuente
COPY server.js ./

# Crear directorio público y copiar archivos estáticos
RUN mkdir -p public
COPY public/ ./public/

# Healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:3000 || exit 1

EXPOSE 3000

CMD ["npm", "start"]