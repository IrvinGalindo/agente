# Dockerfile.nginx - Proxy reverso para organizar todos los servicios
FROM nginx:alpine

# Crear configuraciÃ³n de nginx
COPY <<'EOF' /etc/nginx/nginx.conf
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_size "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 100M;

    # ConfiguraciÃ³n para WebSockets
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    server {
        listen 80;
        server_name localhost;

        # PÃ¡gina principal - Dashboard
        location / {
            return 301 /dashboard/;
        }

        # Dashboard de Ollama Manager
        location /dashboard/ {
            proxy_pass http://ollama-manager:3000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Evolution API
        location /evolution/ {
            proxy_pass http://evolution-api:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Para WebSockets
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # n8n Workflows
        location /n8n/ {
            proxy_pass http://n8n:5678/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Para WebSockets de n8n
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Ollama API
        location /ollama/ {
            proxy_pass http://ollama:11434/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # API directa para compatibilidad
        location /api/ {
            proxy_pass http://ollama:11434/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # PÃ¡gina de informaciÃ³n
        location /info {
            return 200 '
<!DOCTYPE html>
<html>
<head>
    <title>Multi-App Stack Info</title>
    <style>
        body { font-family: Arial; margin: 40px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; }
        .service { margin: 15px 0; padding: 15px; background: #e9ecef; border-radius: 5px; }
        .url { color: #007bff; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ³ Multi-App Stack</h1>
        <p>Todos los servicios estÃ¡n corriendo correctamente:</p>
        
        <div class="service">
            <h3>ğŸ¦™ Ollama Manager</h3>
            <p>Interface web para gestionar modelos LLM</p>
            <p class="url">ğŸ“± <a href="/dashboard/">/dashboard/</a></p>
        </div>
        
        <div class="service">
            <h3>ğŸ“± Evolution API</h3>
            <p>API para WhatsApp Business</p>
            <p class="url">ğŸ”— <a href="/evolution/">/evolution/</a></p>
        </div>
        
        <div class="service">
            <h3>ğŸ”„ n8n Workflows</h3>
            <p>AutomatizaciÃ³n de procesos</p>
            <p class="url">âš¡ <a href="/n8n/">/n8n/</a></p>
        </div>
        
        <div class="service">
            <h3>ğŸ¤– Ollama API</h3>
            <p>API de modelos de lenguaje</p>
            <p class="url">ğŸ”Œ <a href="/ollama/api/tags">/ollama/api/tags</a></p>
        </div>
        
        <h3>ğŸ“‹ URLs Principales:</h3>
        <ul>
            <li><strong>Dashboard:</strong> <code>/dashboard/</code></li>
            <li><strong>Evolution API:</strong> <code>/evolution/</code></li>
            <li><strong>n8n:</strong> <code>/n8n/</code></li>
            <li><strong>Ollama:</strong> <code>/ollama/</code></li>
        </ul>
    </div>
</body>
</html>';
            add_header Content-Type text/html;
        }

        # Health check
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
EOF

EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost/health || exit 1