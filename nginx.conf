user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 100M;
    
    # Configuraci√≥n para WebSockets
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    server {
        listen 10000;
        server_name _;
        
        # P√°gina principal - Dashboard Ollama Manager
        location / {
            proxy_pass http://127.0.0.1:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port $server_port;
        }

        # Dashboard de Ollama Manager (alias)
        location /dashboard {
            return 301 /;
        }

        # Evolution API
        location /evolution {
            rewrite ^/evolution(/.*)$ $1 break;
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Para WebSockets
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # n8n Workflows
        location /n8n {
            rewrite ^/n8n(/.*)$ $1 break;
            proxy_pass http://127.0.0.1:5678;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Para WebSockets de n8n
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Ollama API
        location /ollama {
            rewrite ^/ollama(/.*)$ $1 break;
            proxy_pass http://127.0.0.1:11434;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # API directa para compatibilidad con Ollama Manager
        location /api {
            proxy_pass http://127.0.0.1:11434/api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
        }

        # P√°gina de informaci√≥n
        location /info {
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Multi-App Stack Info</title>
    <style>
        body { font-family: Arial; margin: 40px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; }
        .service { margin: 15px 0; padding: 15px; background: #e9ecef; border-radius: 5px; }
        .url { color: #007bff; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üê≥ Multi-App Stack en Render</h1>
        <p>Todos los servicios est√°n corriendo en un solo contenedor:</p>
        
        <div class="service">
            <h3>ü¶ô Ollama Manager</h3>
            <p>Interface web para gestionar modelos LLM</p>
            <p class="url">üì± <a href="/">P√°gina principal</a></p>
        </div>
        
        <div class="service">
            <h3>üì± Evolution API</h3>
            <p>API para WhatsApp Business</p>
            <p class="url">üîó <a href="/evolution">/evolution</a></p>
        </div>
        
        <div class="service">
            <h3>üîÑ n8n Workflows</h3>
            <p>Automatizaci√≥n de procesos</p>
            <p class="url">‚ö° <a href="/n8n">/n8n</a></p>
        </div>
        
        <div class="service">
            <h3>ü§ñ Ollama API</h3>
            <p>API de modelos de lenguaje</p>
            <p class="url">üîå <a href="/ollama/api/tags">/ollama/api/tags</a></p>
        </div>
    </div>
</body>
</html>';
            add_header Content-Type text/html;
        }

        # Health check
        location /health {
            return 200 "healthy - all services running\n";
            add_header Content-Type text/plain;
        }
    }
}